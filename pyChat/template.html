<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<script type="text/javascript">
    function trim(strText) {
        // this will get rid of leading spaces
        while (strText.substring(0,1) == ' ')
            strText = strText.substring(1, strText.length);

        // this will get rid of trailing spaces
        while (strText.substring(strText.length-1,strText.length) == ' ')
            strText = strText.substring(0, strText.length-1);

       return strText;
    }

    function isKeyTrigger(e,keyCode){
        var argv = isKeyTrigger.arguments;
        var argc = isKeyTrigger.arguments.length;
        var bCtrl = false;
        if(argc > 2){
            bCtrl = argv[2];
        }
        var bAlt = false;
        if(argc > 3){
            bAlt = argv[3];
        }

        var nav4 = window.Event ? true : false;

        if(typeof e == 'undefined') {
            e = event;
        }

        if( bCtrl &&
            !((typeof e.ctrlKey != 'undefined') ?
                e.ctrlKey : e.modifiers & Event.CONTROL_MASK > 0)){
            return false;
        }
        if( bAlt &&
            !((typeof e.altKey != 'undefined') ?
                e.altKey : e.modifiers & Event.ALT_MASK > 0)){
            return false;
        }
        var whichCode = 0;
        if (nav4) whichCode = e.which;
        else if (e.type == "keypress" || e.type == "keydown")
            whichCode = e.keyCode;
        else whichCode = e.button;

        return (whichCode == keyCode);
    }

    function ctrlEnter(e){
        var ie =navigator.appName=="Microsoft Internet Explorer"?true:false;
        if(ie){
            if(event.ctrlKey && window.event.keyCode==13){doSomething();}
        }else{
            if(isKeyTrigger(e,13,true)){send_text();}
        }
    }

    function createXMLHttpRequest()
    {
        if (window.XMLHttpRequest)
        {// code for IE7+, Firefox, Chrome, Opera, Safari
            xmlhttp = new XMLHttpRequest();
        }
        else
        {// code for IE6, IE5
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        return xmlhttp;
    }

    function htmlEncode(s)
    {
        return s.replace(/&(?!\w+([;\s]|$))/g, "&amp;")
            .replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function send_text()
    {
        formobj = document.getElementById("contactus")
        xmlhttp = createXMLHttpRequest();
        xmlhttp.onreadystatechange = function()
        {
            if (xmlhttp.readyState==4 && xmlhttp.status==200)
            {
                poll();
            }
        }
        params = trim(formobj.value);
        xmlhttp.open("POST", "/send_text/", true);
        xmlhttp.setRequestHeader("Content-type", "text/html");
        xmlhttp.setRequestHeader("Content-length", params.length);
        xmlhttp.setRequestHeader("Connection", "close");
        xmlhttp.send(params);
        formobj.value = "";
    }

    function check_time()
    {
        xmlhttp = createXMLHttpRequest();
        xmlhttp.onreadystatechange = function()
        {
            if (xmlhttp.readyState==4 && xmlhttp.status==200)
            {
                document.getElementById("myDiv").innerHTML =
                    xmlhttp.responseText;
            }
        }
        xmlhttp.open("GET", "/timestamp/"
            + trim(document.getElementById("asctime").innerHTML), true);
        xmlhttp.send();
    }

    function poll()
    {
        xmlhttp = createXMLHttpRequest();
        xmlhttp.onreadystatechange = function()
        {
            if (xmlhttp.readyState==4 && xmlhttp.status==200)
            {
                parsed = xmlhttp.responseText.split(",");
                for (i=0; i<parsed.length; i++)
                {
                    pair = parsed[i].split("=");
                    if (pair.length==2)
                    {
                        if (pair[0]=="asctime")
                        {
                            document.getElementById("asctime").innerHTML = pair[1];
                                xmlhttp.responseText;
                        }
                        else if (pair[0]=="msg")
                        {
                            document.getElementById("myDiv").innerHTML = pair[1];
                        }
                    }
                }
            }
        }
        xmlhttp.open("GET", "/check_update/"
            + trim(document.getElementById("asctime").innerHTML), true);
        xmlhttp.send();
    }

    function start_push()
    {
        xmlhttp = createXMLHttpRequest();
        xmlhttp.onreadystatechange = function()
        {
            if (xmlhttp.readyState==4 && xmlhttp.status==200)
            {
                document.getElementById("myDiv").innerHTML =
                    xmlhttp.getResponseHeader;
            }
        }
        xmlhttp.open("GET", "/start_push/", true);
        xmlhttp.send();
    }

    function init_poll()
    {
        poll();
        timer = setInterval(poll, 1000);
    }
</script>
</head>
<body onload="init_poll()">
    <div id="asctime">%s</div>
    <div id="myDiv">%s</div>
    <textarea cols="60" rows="5" id="contactus" name="contactus"
        onkeyup="javascript:return ctrlEnter(event);" ></textarea><br/>
    <button type="button" onclick="check_time()">check_time</button><br/>
    <button type="button" onclick="start_push()">start_push</button><br/>
</body>
</html>
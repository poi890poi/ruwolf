<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>pyChat</title>
<style type="text/css">
    body {
        font-family: helvetica, verdana, arial, sans-serif;
        font-weight: normal }
    table {
        width: 650px }
    td {
        border: 1px solid lightgrey; }
    td.header {
        width: 650px; height: 24px;
        background-color: whitesmoke }
    td.body {
        padding-top:8px }
    b {
        vertical-align: middle; }
</style>
<script type="text/javascript" src="jquery-1.4.4.min.js"></script>
<script type="text/javascript">
    var timestamp = 0;

    function trim(strText) {
        // this will get rid of leading spaces
        while (strText.substring(0,1) == ' ')
            strText = strText.substring(1, strText.length);

        // this will get rid of trailing spaces
        while (strText.substring(strText.length-1,strText.length) == ' ')
            strText = strText.substring(0, strText.length-1);

       return strText;
    }

    function createXMLHttpRequest()
    {
        if (window.XMLHttpRequest)
        {// code for IE7+, Firefox, Chrome, Opera, Safari
            xmlhttp = new XMLHttpRequest();
        }
        else
        {// code for IE6, IE5
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        return xmlhttp;
    }

    function htmlEncode(s)
    {
        return s.replace(/&(?!\w+([;\s]|$))/g, "&amp;")
            .replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function send_text()
    {
        formobj = document.getElementById("text_message")
        xmlhttp = createXMLHttpRequest();
        xmlhttp.onreadystatechange = function()
        {
            if (xmlhttp.readyState==4 && xmlhttp.status==204)
            {
                poll();
            }
        }
        params = trim(formobj.value);
        xmlhttp.open("POST", "/send_text/", true);
        xmlhttp.setRequestHeader("Content-type", "text/html");
        xmlhttp.setRequestHeader("Content-length", params.length);
        xmlhttp.setRequestHeader("Connection", "close");
        xmlhttp.send(params);
        formobj.value = "";
    }

    function poll()
    {
        var my_JSON_object = {};
        xmlhttp = createXMLHttpRequest();
        xmlhttp.onreadystatechange = function()
        {
            if (xmlhttp.readyState==4 && xmlhttp.status==200)
            {
                var scr_to_bottom = (($("#MessageList").attr("scrollTop")+
                    $("#MessageList").height()) - $("#MessageList").attr("scrollHeight"));

                var obj = jQuery.parseJSON(xmlhttp.responseText);
                var tmpstring = "<table cellspacing='0'>";
                var i, N = obj.length;
                for (i=0; i<N; i++) {
                    timestamp = obj[i][1];
                    var dateobj = new Date(timestamp);
                    var msg = new String();
                    msg += "<tr><td class='header'>";
                    msg += "<span><b>"+obj[i][2]+"</b> at "+dateobj.toTimeString()+"<br/></span></td></tr>";
                    msg += "<tr><td class='body'><blockquote>"+obj[i][3]+"</blockquote></td></tr>";
                    msg += "";
                    tmpstring += msg;
                }
                tmpstring += "</table>";
                $("#MessageList").append(tmpstring);

                // is scroll is at bottom, scroll to bottom
                if (scr_to_bottom >= 0) {
                    $("#MessageList").attr({scrollTop: $("#MessageList").attr("scrollHeight")});
                    //document.getElementById("dbg").innerHTML = scr_to_bottom;
                } else {
                    //document.getElementById("dbg").innerHTML = "don't scroll";
                }

                var dateobj = new Date(timestamp);
                document.getElementById("dbg").innerHTML = dateobj.toTimeString();
            }
        }
        params = timestamp + "";
        xmlhttp.open("POST", "/check_update/", true);
        xmlhttp.setRequestHeader("Content-type", "text/html");
        xmlhttp.setRequestHeader("Content-length", params.length);
        xmlhttp.setRequestHeader("Connection", "close");
        xmlhttp.send(params);
    }

    function init_poll()
    {
        poll();
        timer = setInterval(poll, 500);
    }
</script>
</head>
<body onload="init_poll()">
    <div id="MessageList" style="overflow: auto; overflow-x: hidden; width: 650px; height: 600px;">
        <span></span>
    </div>
    <p></p>
    <textarea cols="80" rows="5" id="text_message" name="text_message" wrap="hard"
        style="width: 650px;"></textarea><br/>

    <div id="dbg"></div>
    <img src="pic95264_md.jpg"></img>
    <script type="text/javascript">
        $(document).ready(function(){
            $("img").click(function(){
            $(this).hide();
            });
        });

        $('#text_message').keydown(function(event) {
            if (event.keyCode == '13') {
                event.preventDefault();
                //document.getElementById("dbg").innerHTML = event.originalEvent.type;
                if (event.ctrlKey) {
                    var val = this.value;
                    if (typeof this.selectionStart == "number" && typeof this.selectionEnd == "number") {
                        var start = this.selectionStart;
                        this.value = val.slice(0, start) + "\n" + val.slice(this.selectionEnd);
                        this.selectionStart = this.selectionEnd = start + 1;
                    } else if (document.selection && document.selection.createRange) {
                        this.focus();
                        var range = document.selection.createRange();
                        range.text = "\r\n";
                        range.collapse(false);
                        range.select();
                    }
                } else {
                    send_text();
                }
            }
        });
    </script>
</body>
</html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>pyChat</title>
<link href="style.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="jquery.cookie.js"></script>
<script type="text/javascript" src="http.js"></script>
<script type="text/javascript">
    function resizeUI(wait)
    {
        t_resizeui = setTimeout("resizeUIactual();", wait);
    }

    function resizeUIactual()
    {
        var save = 32;
        var wid = 680;
        if ($(window).width() < 1024)
        {
            wid = $(window).width() - 300 - save;
        }
        if (wid < 450) wid = 450;
        $("#MessageList").width(wid-2);
        $("#PostMessage textarea").width(wid);

        var offset = $("#MessageList").offset();
        offset.left += wid + save;
        $("#UserList").offset(offset);

        var scr_to_bottom = (($("#MessageList").attr("scrollTop")+
            $("#MessageList").outerHeight()) - $("#MessageList").attr("scrollHeight"));

        var seth = 0;
        var postm = $("#PostMessage").outerHeight();
        var login = 0;
        if ($('#Login').is(':visible')) {
            login = $("#Login").outerHeight();
        }
        seth = $(window).height() - postm - login - save;
        if (seth < 200 ) seth = 200;
        $("#MessageList").height(seth);
        //$("#Toolbar").height($(window).height()-save);

        var utilp = 16;
        var utilh = 0;
        if ($('#Utility').is(':visible')) {
            itemh = $("#Utility #UtilityContainer .active").outerHeight();
            $("#Utility #UtilityContainer").height(itemh);
            utilh = $("#Utility").outerHeight();
        }
        seth = $(window).height() - utilh - save;
        if (seth < 200 ) seth = 200;
        $("#UserList").height(seth-utilp);

        offset.top += $("#UserList").outerHeight() + utilp;
        $("#Utility").offset(offset);

        if (scr_to_bottom >= 0) {
            $("#MessageList").attr({scrollTop: $("#MessageList").attr("scrollHeight")});
        }
    }
</script>
</head>
<body>
    <div id="MessageList">
    </div>
    <div id="PostMessage">
        <textarea id="EditMessage" wrap="hard"></textarea><br/>
    </div>
        <script type="text/javascript">
            $('#EditMessage').keydown(function(event) {
                if (event.keyCode == '13') {
                    event.preventDefault();
                    if (event.ctrlKey) {
                        var val = this.value;
                        if (typeof this.selectionStart == "number" && typeof this.selectionEnd == "number") {
                            var start = this.selectionStart;
                            this.value = val.slice(0, start) + "\n" + val.slice(this.selectionEnd);
                            this.selectionStart = this.selectionEnd = start + 1;
                        } else if (document.selection && document.selection.createRange) {
                            this.focus();
                            var range = document.selection.createRange();
                            range.text = "\r\n";
                            range.collapse(false);
                            range.select();
                        }
                    } else {
                        send_text();
                    }
                }
            });
        </script>
    <div id="Login">
        <table cellspacing='0'>
        <tr>
            <td colspan="2">
                <b>Please provide login information to get full access.</b>
            </td>
        </tr>
        <tr>
            <td style="width: 80px">Username:</td>
            <td style="width: 420px"><input id="Username"></input></td>
        </tr>
        <tr>
            <td>Password:</td>
            <td><input id="Password"></input></td>
        </tr>
        </table>
    </div>
        <script type="text/javascript">
            $('#Password').keydown(function(event) {
                if (event.keyCode == '13') {
                    event.preventDefault();
                    if (!event.ctrlKey) {
                        login();
                    }
                }
            });
        </script>

    <div id="UserList">
        <div class="titlebar">
            User List
        </div>
        <div id="UserListContainer">
        </div>
    </div>

    <div id="Utility">
        <div class="titlebar">
            Utility
        </div>
        <div id="UtilityContainer">
            <div id="Util0" class="inactive"></div>
            <div id="Util1" class="active">
                <img class="role" src="images/wolf.png"></img><br/>
                You are a werewolf. Only wolves know your identity.
                Your goal is to eliminate all apples in the township,
                without getting caught by the mob. Don't get yourself lynched!<br/><br/>
            </div>
            <div id="Util2" class="inactive">
                Info Box<br/><br/>
            </div>
        </div>
    </div>

    <div class="contextmenu" id="MenuContainerGeneral">
        <div class="menuitem" id="MnuHelp">Help</div>
        <div class="menuitem">About</div>
        <div class="menuitem" id="MnuHost">Host Game</div>
        <hr/>
        <div class="menuitem" id="MnuQuit">Leave Game</div>
        <div class="menuitem" id="MnuLogout">Logout</div>
    </div>

    <div class="contextmenu" id="MenuContainerHost">
        <div class="menuitem" id="MnuHostHelp">Help</div>
        <hr/>
        <div class="menuitem" id="MnuReadyCheck">Ready Check</div>
        <hr/>
        <div class="menuitem" id="MnuDrop">Drop Game</div>
    </div>

    <div class="contextmenu" id="MenuContainerTarget">
        <div class="menuitem" id="MnuTarget">Vote</div>
    </div>

    <div class="contextmenu" id="MenuContainerDoubleTarget">
        <div class="menuitem" id="MnuTarget1">Vote</div>
        <hr/>
        <div class="menuitem" id="MnuTarget2">Vote</div>
    </div>

    <div class="contextmenu" id="MenuContainerRoom">
        <div class="menuitem" id="MnuJoin">Join</div>
    </div>

    <div id="dbg"></div>

    <script type="text/javascript">
        $(window).load(function(){
            $("#UtilityContainer #Util1").click(function(){
                $(this).removeClass("active");
                $(this).addClass("inactive");
                $("#UtilityContainer #Util2").removeClass("inactive");
                $("#UtilityContainer #Util2").addClass("active");
                resizeUI(0);
            });

            $("#tabs li").click(function() {
                $("#tabs li").removeClass('active');
                $(this).addClass("active");
                $(".tab_content").hide();
                var selected_tab = $(this).find("a").attr("href");
                $(selected_tab).fadeIn();
                return false;
            });

    		$(".menuitem").live("mouseover", function (e) {
    	        $(this).addClass("menuhover");
    		});
    		$(".menuitem").live("mouseout", function (e) {
    	        $(this).removeClass("menuhover");
    		});
            $(document).click(function(e) {
        		$(".contextmenu").hide();
            });

            $("#MnuHelp").click(function(e) {
                if ($(this).hasClass("menudisable")) return;
        		$(".contextmenu").hide();
            });
            $("#MnuQuit").click(function(e) {
                if ($(this).hasClass("menudisable")) return;
        		$(".contextmenu").hide();
                send_text("/quit");
            });
            $("#MnuLogout").live("click", function(e) {
                if ($(this).hasClass("menudisable")) return;
        		$(".contextmenu").hide();
                send_text("/logout");
            });
            $("#MnuHost").live("click", function(e) {
                if ($(this).hasClass("menudisable")) return;
        		$(".contextmenu").hide();
                //var description = "[rnd]";
                //send_text("/host " + description);
                window.location = "./host.html"
            });
            $("#MnuReadyCheck").click(function(e) {
                if ($(this).hasClass("menudisable")) return;
        		$(".contextmenu").hide();
                send_text("/ready");
            });
            $("#MnuDrop").click(function(e) {
                if ($(this).hasClass("menudisable")) return;
        		$(".contextmenu").hide();
                send_text("/drop");
            });

            $(document)[0].oncontextmenu = function() {return false;}
            $(document).mousedown(function(e){
                if( e.button == 2 ) {
            		$(".contextmenu").hide();
                    if (e.ctrlKey) {
                        return true;
                    }

                    // user status (roomid, user_status[user], role, username)
                    //alert(userjson);
                    var userobj = jQuery.parseJSON(userjson);
                    if (userobj.length < 4)
                    {
                        return true;
                    }

                    if (userobj[0]) { // is in room
                        $("#MnuLogout").removeClass("menuitem")
                            .addClass("menudisable");
                        $("#MnuHost").removeClass("menuitem")
                            .addClass("menudisable");
                    } else {
                        $("#MnuLogout").removeClass("menudisable")
                            .addClass("menuitem");
                        $("#MnuHost").removeClass("menudisable")
                            .addClass("menuitem");
                    }

                    // room (description, ruleset, options, phase, host, roomid, participant)
                    //alert(roomjson);
                    var roomobj = jQuery.parseJSON(roomjson);
                    var ishost = false;
                    if (roomobj.length >=5 && userobj.length >= 4)
                    {
                        if (roomobj[3] == 0) {
                            $("#MnuQuit").addClass("menuitem")
                                .removeClass("menudisable");
                        } else {
                            $("#MnuQuit").removeClass("menuitem")
                                .addClass("menudisable");
                        }
                        if (roomobj[4] == userobj[3]) {
                            ishost = true;
                        }
                    } else {
                        $("#MnuQuit").removeClass("menuitem")
                            .addClass("menudisable");
                    }

                    if (ishost) {
                		var menu = $("#MenuContainerHost");
                        if (roomobj[3] > 0) {
                            $("#MnuReadyCheck").html("Open Game");
                        } else {
                            $("#MnuReadyCheck").html("Ready Check");
                        }
                		menu.css("left", e.pageX+"px");
                		menu.css("top", e.pageY+"px");
                		setTimeout("$('#MenuContainerHost').show();", 120);
            			return false;
                    } else {
                		var menu = $("#MenuContainerGeneral");
                		menu.css("left", e.pageX+"px");
                		menu.css("top", e.pageY+"px");
                		setTimeout("$('#MenuContainerGeneral').show();", 120);
            			return false;
                    }
                } else {
                    return true;
                }
            });

            $("#UserList div.clk_user").live("click", function(e) {
        		$(".contextmenu").hide();

                // user status (roomid, user_status[user], role, username)
                var userobj = jQuery.parseJSON(userjson);
                if (userobj.length < 4)
                {
                    return true;
                }

                var targetname = "";
                var target = jQuery.parseJSON($(this).attr('data-json'));
                if (target.length >= 4)
                {
                    targetname = target[3];
                }

                // room (description, ruleset, options, phase, host, roomid, participant)
                var phase = 0;
                var roomid = "";
                var roomobj = jQuery.parseJSON(roomjson);
                if (roomobj.length >= 6)
                {
                    phase = roomobj[3];
                    roomid = roomobj[5];
                }

                //if ((roomid) && (phase == 1) && (userobj[1] & 256) && (targetname != userobj[3])) { // vote for ready, USR_RDYCHK
                if ((roomid) && (phase == 1) && (userobj[1] & 256)) { // vote for ready, USR_RDYCHK
            		var join = $("#MnuTarget");
                    join.html("Vote for <b>" + layoutSafeStr(targetname) + "</b>");
            		join.unbind("click");
            		join.click(function (e) {
                        send_text("/vote_rdy " + targetname);
            		});
                } else if ((userobj[1] & 4) && (targetname != userobj[3])) { // game host, USR_HOST
            		var join = $("#MnuTarget");
                    join.html("Kick <b>" + layoutSafeStr(targetname) + "</b>");
            		join.unbind("click");
            		join.click(function (e) {
                        send_text("/kick " + targetname);
            		});
                } else {
                    return true;
                }

        		var menu = $("#MenuContainerTarget");
        		menu.css("left", e.pageX+"px");
        		menu.css("top", e.pageY+"px");
        		setTimeout("$('#MenuContainerTarget').show();", 120);
                return false;
            });

            $("#UserList div.clk_room").live("click", function(e) {
        		$(".contextmenu").hide();

                //alert($(this).attr("data-json"));
                // room (description, ruleset, options, phase, host, roomid, participant)
                if (!sessionkey)
                {
                    return true;
                }

                var data_json = jQuery.parseJSON($(this).attr("data-json"));
                var roomid = data_json[5];

                if (data_json[3] > 0)
                {
                    // not in recruiting
                    return true;
                }

        		var join = $("#MnuJoin");
                join.html("Join <b>" + layoutSafeStr(data_json[0]) + "</b>");
        		join.unbind("click");
        		join.click(function (e) {
                    send_text("/join " + roomid);
        		});
        		var menu = $("#MenuContainerRoom");
        		menu.css("left", e.pageX+"px");
        		menu.css("top", e.pageY+"px");
        		setTimeout("$('#MenuContainerRoom').show();", 120);
                return false;
            });

            resizeUI(0);

            init_poll();
        });

        $(window).resize(function(){
            resizeUI(500);
        });
    </script>
</body>
</html>
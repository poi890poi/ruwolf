<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>pyChat</title>
<style type="text/css">
    bodyforenglish {
        font-family: helvetica, verdana, arial, sans-serif;
        font-weight: normal }
    body {
        font-family: 細明體; }

    #MessageList {
        overflow: auto; overflow-x: hidden;
        width: 648px; height: 600px;
        border: 1px solid black;
    }
    #MessageList table {
        table-layout: fixed;
        width: 638px;
    }
    #MessageList td {
        padding: 6px 6px 15px 6px;
        border-top: 1px dashed #999999;
    }
    #MessageList td.system {
        padding: 20px 50px;
        background: #cccccc;
    }
    #MessageList td.lead {
        width: 125px;
        padding-right: 15px;
    }

    #PostMessage {
        padding-top: 16px;
    }
    #PostMessage textarea {
        width: 650px; height: 80px;
    }
    #Login {
        padding-top: 16px;
        display: none;
    }
    #Toolbar {
        position: absolute;
        width: 300px;
        left: 680px; top: 16px;
        border: 0px solid black;
    }
    #Toolbar #tabs_content_container {
        overflow: auto; overflow-x: hidden;
        vertical-align: top;
        width: 298px;
        border: 1px solid black; }
    #Toolbar #tabs_content_container div {
        margin-bottom: 2px;
    }
    #Toolbar #tabs_content_container .tab_content {
        padding: 6px 9px;
        display: none;
    }
    img.usericon {
        vertical-align: text-bottom;
        padding-right: 3px;
    }
    img.role {
        width: 298px;
    }
    div.contextmenu {
        padding: 4px;
        position: absolute;
		width: 220px;
        background: #eeeeee;
        border: 2px solid #777777;
        border-top: 2px solid #dddddd;
        border-left: 2px solid #dddddd;
        display: none;
    }
    div.menuitem {
        cursor: pointer;
        padding: 4px 26px;
    }
    div.menudisable {
        padding: 4px 26px;
        color: #cccccc;
    }
    div.menuhover {
        color: white;
        background: royalblue;
    }
    .clkable {
        cursor: pointer;
    }
</style>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="jquery.cookie.js"></script>
<script type="text/javascript" src="http.js"></script>
<script type="text/javascript">
    function resizeUI(wait)
    {
        setTimeout("resizeUIactual();", wait);
    }

    function resizeUIactual()
    {
        var scr_to_bottom = (($("#MessageList").attr("scrollTop")+
            $("#MessageList").outerHeight()) - $("#MessageList").attr("scrollHeight"));

        var seth = 0;
        var postm = $("#PostMessage").outerHeight();
        var login = 0;
        var save = 32;
        if ($('#Login').is(':visible')) {
            login = $("#Login").outerHeight();
        }
        seth = $(window).height() - postm - login - save;
        if (seth < 200 ) seth = 200;
        $("#MessageList").height(seth);
        //$("#Toolbar").height($(window).height()-save);

        var tbc = $("#tabs_container").outerHeight();
        var role = 0;
        var save = 32;
        if ($('#role').is(':visible')) {
            role = $("#role").outerHeight();
        }
        seth = $(window).height() - tbc - role - save;
        if (seth < 200 ) seth = 200;
        $("#tabs_content_container").height(seth);

        if (scr_to_bottom >= 0) {
            $("#MessageList").attr({scrollTop: $("#MessageList").attr("scrollHeight")});
        }
    }
</script>
</head>
<body>
    <div id="MessageList">
    </div>
    <div id="PostMessage">
        <textarea id="EditMessage" wrap="hard"></textarea><br/>
    </div>
        <script type="text/javascript">
            $('#EditMessage').keydown(function(event) {
                if (event.keyCode == '13') {
                    event.preventDefault();
                    if (event.ctrlKey) {
                        var val = this.value;
                        if (typeof this.selectionStart == "number" && typeof this.selectionEnd == "number") {
                            var start = this.selectionStart;
                            this.value = val.slice(0, start) + "\n" + val.slice(this.selectionEnd);
                            this.selectionStart = this.selectionEnd = start + 1;
                        } else if (document.selection && document.selection.createRange) {
                            this.focus();
                            var range = document.selection.createRange();
                            range.text = "\r\n";
                            range.collapse(false);
                            range.select();
                        }
                    } else {
                        send_text();
                    }
                }
            });
        </script>
    <div id="Login">
        <table cellspacing='0'>
        <tr>
            <td colspan="2">
                <b>Please provide login information to get full access.</b>
            </td>
        </tr>
        <tr>
            <td style="width: 80px">Username:</td>
            <td style="width: 420px"><input id="Username"></input></td>
        </tr>
        <tr>
            <td>Password:</td>
            <td><input id="Password"></input></td>
        </tr>
        </table>
    </div>
        <script type="text/javascript">
            $('#Password').keydown(function(event) {
                if (event.keyCode == '13') {
                    event.preventDefault();
                    if (!event.ctrlKey) {
                        login();
                    }
                }
            });
        </script>

    <div id="Toolbar">
        <div id="tabs_container">
            <ul id="tabs">
                <li class="active"><a href="#tab1">Players</a></li>
                <li><a class="icon_accept" href="#tab2">Memo</a></li>
                <li><a href="#tab3">Options</a></li>
            </ul>
        </div>
        <div id="tabs_content_container">
            <div id="tab1" class="tab_content" style="display: block;">
            </div>
            <div id="tab2" class="tab_content">
                <p>This tab has icon in it.</p>
            </div>
            <div id="tab3" class="tab_content">
                <p>
                    <input type="checkbox" name="chkLogout"/> Save credential<br/>
                    <input type="checkbox" name="chkNotify"/> Sound notify<br/>
                    <input type="checkbox" name="chkNotify"/> High latency mode<br/>
                </p>
            </div>
        </div>
        <div id="role">
            <img class="role" src="images/wolf.png"></img><br/>
            You are a werewolf. Only wolves know your identity.
            Your goal is to eliminate all apples in the township,
            without getting caught by the mob. Don't get yourself lynched!<br/><br/>
        </div>
    </div>

    <div class="contextmenu" id="MenuContainerGeneral">
        <div class="menuitem" id="MnuHelp">Help</div>
        <div class="menuitem">About</div>
        <div class="menuitem" id="MnuHost">Host Game</div>
        <hr/>
        <div class="menuitem" id="MnuQuit">Leave Game</div>
        <div class="menuitem" id="MnuLogout">Logout</div>
    </div>

    <div class="contextmenu" id="MenuContainerHost">
        <div class="menuitem" id="MnuHostHelp">Help</div>
        <hr/>
        <div class="menuitem" id="MnuReadyCheck">Ready Check</div>
        <hr/>
        <div class="menuitem" id="MnuDrop">Drop Game</div>
    </div>

    <div class="contextmenu" id="MenuContainerTarget">
        <div class="menuitem" id="MnuTarget">Vote</div>
    </div>

    <div class="contextmenu" id="MenuContainerDoubleTarget">
        <div class="menuitem" id="MnuTarget1">Vote</div>
        <hr/>
        <div class="menuitem" id="MnuTarget2">Vote</div>
    </div>

    <div class="contextmenu" id="MenuContainerRoom">
        <div class="menuitem" id="MnuJoin">Join</div>
    </div>

    <div id="dbg"></div>

    <script type="text/javascript">
        $(window).load(function(){
            $("#role").click(function(){
                $(this).hide();
                resizeUI(0);
            });

            $("#tabs li").click(function() {
                $("#tabs li").removeClass('active');
                $(this).addClass("active");
                $(".tab_content").hide();
                var selected_tab = $(this).find("a").attr("href");
                $(selected_tab).fadeIn();
                return false;
            });

            $(document)[0].oncontextmenu = function() {return false;}
            $(document).mousedown(function(e){
                if( e.button == 2 ) {
            		$(".contextmenu").hide();
                    if (e.ctrlKey) {
                        return true;
                    }

                    // user status (roomid, user_status[user], role, username)
                    //alert(userjson);
                    var userobj = jQuery.parseJSON(userjson);
                    if (userobj.length < 4)
                    {
                        return true;
                    }

                    if (userobj[0]) { // is in room
                        $("#MnuLogout").removeClass("menuitem")
                            .addClass("menudisable");
                        $("#MnuHost").removeClass("menuitem")
                            .addClass("menudisable");
                    } else {
                        $("#MnuLogout").removeClass("menudisable")
                            .addClass("menuitem");
                        $("#MnuHost").removeClass("menudisable")
                            .addClass("menuitem");
                    }

                    // room (description, ruleset, options, phase, host, roomid, participant)
                    //alert(roomjson);
                    var roomobj = jQuery.parseJSON(roomjson);
                    var ishost = false;
                    if (roomobj.length >=5 && userobj.length >= 4)
                    {
                        if (roomobj[3] == 0) {
                            $("#MnuQuit").addClass("menuitem")
                                .removeClass("menudisable");
                        } else {
                            $("#MnuQuit").removeClass("menuitem")
                                .addClass("menudisable");
                        }
                        if (roomobj[4] == userobj[3]) {
                            ishost = true;
                        }
                    } else {
                        $("#MnuQuit").removeClass("menuitem")
                            .addClass("menudisable");
                    }

                    if (ishost) {
                		var menu = $("#MenuContainerHost");
                        if (roomobj[3] > 0) {
                            $("#MnuReadyCheck").html("Open Game");
                        } else {
                            $("#MnuReadyCheck").html("Ready Check");
                        }
                		menu.css("left", e.pageX+"px");
                		menu.css("top", e.pageY+"px");
                		setTimeout("$('#MenuContainerHost').show();", 120);
            			return false;
                    } else {
                		var menu = $("#MenuContainerGeneral");
                		menu.css("left", e.pageX+"px");
                		menu.css("top", e.pageY+"px");
                		setTimeout("$('#MenuContainerGeneral').show();", 120);
            			return false;
                    }
                } else {
                    return true;
                }
            });
    		$(".menuitem").live("mouseover", function (e) {
    	        $(this).addClass("menuhover");
    		});
    		$(".menuitem").live("mouseout", function (e) {
    	        $(this).removeClass("menuhover");
    		});
            $(document).click(function(e) {
        		$(".contextmenu").hide();
            });

            $("#MnuHelp").click(function(e) {
                if ($(this).hasClass("menudisable")) return;
        		$(".contextmenu").hide();
            });
            $("#MnuQuit").click(function(e) {
                if ($(this).hasClass("menudisable")) return;
        		$(".contextmenu").hide();
                send_text("/quit");
            });
            $("#MnuLogout").live("click", function(e) {
                if ($(this).hasClass("menudisable")) return;
        		$(".contextmenu").hide();
                send_text("/logout");
            });
            $("#MnuHost").live("click", function(e) {
                if ($(this).hasClass("menudisable")) return;
        		$(".contextmenu").hide();
                //var description = prompt("Please enter a brief description."); // doesn't work in IE
                var description = "[rnd]";
                send_text("/host " + description);
            });
            $("#MnuReadyCheck").click(function(e) {
                if ($(this).hasClass("menudisable")) return;
        		$(".contextmenu").hide();
                send_text("/ready");
            });
            $("#MnuDrop").click(function(e) {
                if ($(this).hasClass("menudisable")) return;
        		$(".contextmenu").hide();
                send_text("/drop");
            });

            $("#Toolbar div.clk_user").live("click", function(e) {
        		$(".contextmenu").hide();

                // user status (roomid, user_status[user], role, username)
                var userobj = jQuery.parseJSON(userjson);
                if (userobj.length < 4)
                {
                    return true;
                }

                var targetname = "";
                var target = jQuery.parseJSON($(this).attr('data-json'));
                if (target.length >= 4)
                {
                    targetname = target[3];
                }

                // room (description, ruleset, options, phase, host, roomid, participant)
                var phase = 0;
                var roomid = "";
                var roomobj = jQuery.parseJSON(roomjson);
                if (roomobj.length >= 6)
                {
                    phase = roomobj[3];
                    roomid = roomobj[5];
                }

                if ((roomid) && (phase == 1) && (userobj[1] & 256) && (targetname != userobj[3])) { // vote for ready, USR_RDYCHK
            		var join = $("#MnuTarget");
                    join.html("Vote for <b>" + layoutSafeStr(targetname) + "</b>");
            		join.unbind("click");
            		join.click(function (e) {
                        send_text("/vote_rdy " + targetname);
            		});
                } else if ((userobj[1] & 4) && (targetname != userobj[3])) { // game host, USR_HOST
            		var join = $("#MnuTarget");
                    join.html("Kick <b>" + layoutSafeStr(targetname) + "</b>");
            		join.unbind("click");
            		join.click(function (e) {
                        send_text("/kick " + targetname);
            		});
                } else {
                    return true;
                }

        		var menu = $("#MenuContainerTarget");
        		menu.css("left", e.pageX+"px");
        		menu.css("top", e.pageY+"px");
        		setTimeout("$('#MenuContainerTarget').show();", 120);
                return false;
            });

            $("#Toolbar div.clk_room").live("click", function(e) {
        		$(".contextmenu").hide();

                //alert($(this).attr("data-json"));
                // room (description, ruleset, options, phase, host, roomid, participant)
                if (!sessionkey)
                {
                    return true;
                }

                var data_json = jQuery.parseJSON($(this).attr("data-json"));
                var roomid = data_json[5];

                if (data_json[3] > 0)
                {
                    // not in recruiting
                    return true;
                }

        		var join = $("#MnuJoin");
                join.html("Join <b>" + layoutSafeStr(data_json[0]) + "</b>");
        		join.unbind("click");
        		join.click(function (e) {
                    send_text("/join " + roomid);
        		});
        		var menu = $("#MenuContainerRoom");
        		menu.css("left", e.pageX+"px");
        		menu.css("top", e.pageY+"px");
        		setTimeout("$('#MenuContainerRoom').show();", 120);
                return false;
            });

            var offset = $("#MessageList").offset();
            offset.left += 680;
            $("#Toolbar").offset(offset);

            resizeUI(0);

            init_poll();
        });

        $(window).resize(function(){
            resizeUI(500);
        });
    </script>
</body>
</html>
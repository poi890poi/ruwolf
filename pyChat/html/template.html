<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>pyChat</title>
<style type="text/css">
    .odd {
        color: black;
        background-color: white }
    .even {
        color: black;
        background-color: azure }
</style>
<script type="text/javascript" src="jquery-1.4.4.min.js"></script>
<script type="text/javascript">
    var timestamp = "0";

    function trim(strText) {
        // this will get rid of leading spaces
        while (strText.substring(0,1) == ' ')
            strText = strText.substring(1, strText.length);

        // this will get rid of trailing spaces
        while (strText.substring(strText.length-1,strText.length) == ' ')
            strText = strText.substring(0, strText.length-1);

       return strText;
    }

    function createXMLHttpRequest()
    {
        if (window.XMLHttpRequest)
        {// code for IE7+, Firefox, Chrome, Opera, Safari
            xmlhttp = new XMLHttpRequest();
        }
        else
        {// code for IE6, IE5
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        return xmlhttp;
    }

    function htmlEncode(s)
    {
        return s.replace(/&(?!\w+([;\s]|$))/g, "&amp;")
            .replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function send_text()
    {
        formobj = document.getElementById("contactus")
        xmlhttp = createXMLHttpRequest();
        xmlhttp.onreadystatechange = function()
        {
            if (xmlhttp.readyState==4 && xmlhttp.status==204)
            {
                poll();
            }
        }
        params = trim(formobj.value);
        xmlhttp.open("POST", "/send_text/", true);
        xmlhttp.setRequestHeader("Content-type", "text/html");
        xmlhttp.setRequestHeader("Content-length", params.length);
        xmlhttp.setRequestHeader("Connection", "close");
        xmlhttp.send(params);
        formobj.value = "";
    }

    function check_time()
    {
        xmlhttp = createXMLHttpRequest();
        xmlhttp.onreadystatechange = function()
        {
            if (xmlhttp.readyState==4 && xmlhttp.status==200)
            {
                document.getElementById("myDiv").innerHTML =
                    xmlhttp.responseText;
            }
        }
        xmlhttp.open("GET", "/timestamp/"+timestamp, true);
        xmlhttp.send();
    }

    function poll()
    {
        var my_JSON_object = {};
        xmlhttp = createXMLHttpRequest();
        xmlhttp.onreadystatechange = function()
        {
            if (xmlhttp.readyState==4 && xmlhttp.status==200)
            {
                var obj = jQuery.parseJSON(xmlhttp.responseText);
                var tmpstring = new String();
                var i, N = obj.length;
                for (i=0; i<N; i++) {
                    var msg = new String();
                    msg += "<p>";
                    msg += "<b>"+obj[i][2]+"</b> at "+obj[i][1]+"<br/>";
                    msg += "<blockquote>"+obj[i][3]+"</blockquote>";
                    msg += "</p>";
                    $("p:first").before(msg);
                    timestamp = obj[i][1];
                }
                //$("#myDiv").attr({scrollTop: $("#myDiv").attr("scrollHeight")});
            }
            // scroll to bottom doesn't work
            //var objDiv = document.getElementById("myDiv");
            //objDiv.scrollTop = objDiv.scrollHeight;
        }
        params = timestamp;
        xmlhttp.open("POST", "/check_update/", true);
        xmlhttp.setRequestHeader("Content-type", "text/html");
        xmlhttp.setRequestHeader("Content-length", params.length);
        xmlhttp.setRequestHeader("Connection", "close");
        xmlhttp.send(params);
    }

    function init_poll()
    {
        poll();
        timer = setInterval(poll, 500);
    }
</script>
</head>
<body onload="init_poll()">
    <textarea cols="60" rows="5" id="contactus" name="contactus"></textarea><br/>
    <img src="pic95264_md.jpg"></img>
    <div id="myDiv"></div>
    <p></p>
    <div id="dbg"></div>
    <script type="text/javascript">
        $(document).ready(function(){
            $("img").click(function(){
            $(this).hide();
            });
        });

        $('#contactus').keyup(function(event) {
            if (event.keyCode == '13') {
                if (event.ctrlKey) {
                    var txt = $("textarea#contactus");
                    txt.val(txt.val()+"\n");
                } else {
                    send_text();
                }
            }
        });
    </script>
</body>
</html>